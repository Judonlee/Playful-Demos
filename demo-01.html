<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Perceptive Media: Playful Demos</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<style>
span.module {
	background-color: #ccc;
	border: 1px solid #666;
	padding: 5px;
	margin-right: 10px;
	border-radius: 0px 5px 5px 0;
	font-weight: bold;
}
.module button {
	background-color: #ccf;
	border: 2px solid #669;
	border-radius: 5px;
	font-weight: bold;
}
</style>
</head>
<body>

	<div id="story"></div>

	<canvas id="spectrum" width="1275" height="255" style="display: block; border: 1px solid #000;"></canvas>
	<canvas id="energy" width="1275" height="255" style="display: block; border: 1px solid #000;"></canvas>

	<p>
		<span id="story" class="module">
			Story:
			<button id="story-play">play</button>
			<button id="story-pause">pause</button>
			<button id="story-reset">reset</button>
			<button id="story-next">next</button>
			<input type="radio" name="story-track" id="story-track-all" value="" checked />
			<label for="story-track-all">ALL</label>
			<input type="radio" name="story-track" id="story-track-story" value="story" />
			<label for="story-track-story">story</label>
			<input type="radio" name="story-track" id="story-track-bgm" value="bgm" />
			<label for="story-track-bgm">bgm</label>
		</span>
	</p>
	<p>
		<button id="log">log</button>
	</p>

<script type="text/javascript" src="assets/js/detectors/vad.js"></script>
<script type="text/javascript" src="assets/js/outputs/graph.js"></script>
<script type="text/javascript" src="assets/js/outputs/story.js"></script>
<script type="text/javascript">

	var context = new (window.AudioContext || window.webkitAudioContext)();
	var microphone;
	var analyser;
	var javascriptNode;

	// Use Graph module to display the spectrum
	var graph_spectrum = new Graph({
		canvas: {
			id: 'spectrum',
			width: 1275,
			height: 255
		}
	});

	// Use Graph module to display the energy
	var graph_energy = new Graph({
		canvas: {
			id: 'energy',
			width: 1275,
			height: 255
		}
	});

	var myVad;

	function gotAudio(stream) {

		microphone = context.createMediaStreamSource(stream);

		// setup a javascript node
		// javascriptNode = context.createScriptProcessor(2048, 1, 1);
		javascriptNode = context.createScriptProcessor(512, 1, 1);
		// connect to destination, else it isn't called
		javascriptNode.connect(context.destination);

		// setup an analyzer
		analyser = context.createAnalyser();
		analyser.smoothingTimeConstant = 0.99; // 0.3;
		analyser.fftSize = 512;

		// analyser.maxDecibels = -20;
		// analyser.minDecibels = -60;

		// connect up the nodes
		microphone.connect(analyser);
		analyser.connect(javascriptNode);

		myVad = new vad(analyser);

		// when the javascript node is called
		// we use information from the analyzer node
		// to draw the volume
		javascriptNode.onaudioprocess = function() {

			// get the average for the first channel
			var array = new Uint8Array(analyser.frequencyBinCount);
			analyser.getByteFrequencyData(array);
			graph_spectrum.draw(array);

			graph_energy.draw([
				myVad.getEnergy(),
				myVad.getEnergyB(),
				myVad.getEnergyC(),
				255e8 * myVad.getEnergyD(),
				255e8 * myVad.energyMonitor(),
				255*myVad.getFrequency()/12000, // Normalized the frequency so 12kHz is max on graph
				-25.5*myVad.getSFM(),
				255*myVad.iterate()
			]);
		};

		// TMP - Remove to avoid feedback!
		// microphone.connect(context.destination);
	}

	function logError(error) {
		console.log(error.name + ": " + error.message);
	}

	// console.dir(navigator);
	// navigator.getUserMedia('audio', gotAudio, logError);

	if(navigator.getUserMedia) { // W3C
		navigator.getUserMedia({audio:true}, gotAudio, logError);
	} else if(navigator.webkitGetUserMedia) { // WebKit
		navigator.webkitGetUserMedia({audio:true}, gotAudio, logError);
	} else if(navigator.mozGetUserMedia) { // Mozilla
		navigator.mozGetUserMedia({audio:true}, gotAudio, logError);
	}

	console.log("sample rate: " + context.sampleRate);

	var logBtn = document.querySelector('#log');
	if(logBtn) {
		logBtn.addEventListener('click', function() {
			myVad.triggerLog();
		}, false);
	}

	var tangye = {
		list: {}, // where the parsed results are stored.
		// story: '', // default
		ignore: '', // ignore these numbers.
		bgm: '1', // music
		sfx: '' // sound effect
	};

	tangye.list.ignore = tangye.ignore.split(/\s+/g);
	tangye.list.bgm = tangye.bgm.split(/\s+/g);
	tangye.list.sfx = tangye.sfx.split(/\s+/g);

	var autoStory = [],
		autoAudio = {},
		autoURL = '';
	for(var aa=0, aaLen = 300; aa < aaLen; aa++) {
		if(aa < 10) {
			autoURL = '00';
		} else if(aa < 100) {
			autoURL = '0';
		}
		autoAudio = {
			// mp3: 'assets/audio/tangye/00002.mp3'
			mp3: 'assets/audio/tangye/00' + autoURL + aa + '.mp3'
		};
		autoStory.push(autoAudio);
	}

	var myStory = new Story({
		wrapper: {
			id: 'story'
		},
		track: {
			story: autoStory,
	/*
			[
				{
					mp3: 'assets/audio/tangye/00002.mp3'
				},
				{
					mp3: 'assets/audio/tangye/00003.mp3'
				},
				{
					mp3: 'assets/audio/tangye/00004.mp3'
				}
			],
	*/
			bgm: [
				{
					mp3: 'assets/audio/tangye/00001.mp3',
					vol: 0.1
				}
			]
		}
	});

	document.querySelector('#story-play').addEventListener('click', function() {
		myStory.play(getTrack());
	}, false);
	document.querySelector('#story-pause').addEventListener('click', function() {
		myStory.pause(getTrack());
	}, false);
	document.querySelector('#story-reset').addEventListener('click', function() {
		myStory.resetTrack(getTrack());
	}, false);
	document.querySelector('#story-next').addEventListener('click', function() {
		myStory.nextAudio(getTrack());
	}, false);


	var getRadioValue = function(name) {
		var value;
		var options = document.getElementsByName(name);
		for(var i = 0; i < options.length; i++) {
			if(options[i].checked === true) {
				value = options[i].value;
				console.log('getRadioValue: value = "' + value + '"');
			}
		}
		return value;
	};

	var getTrack = function() {
		var track = getRadioValue("story-track");
		track = track ? track : undefined;
		return track;
	}

	// getRadioValue("story-track");
</script>
</body>
</html>
