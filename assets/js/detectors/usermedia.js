/*
 * UserMedia Library
 * http://www.happyworm.com
 *
 * Copyright (c) 2014 Happyworm Ltd
 * Licensed under the MIT license.
 * http://opensource.org/licenses/MIT
 *
 * Author: Mark J Panaghiston
 * Version: 0.0.1
 * Date: 21st May 2014
 *
 * Requires:
 * headtrackr.js (https://github.com/auduno/headtrackr/)
 */

(function(PM) {

	var DEBUG = true;

	var UserMedia = function(options) {
		this.init(options);
	};

	if(typeof PM === 'undefined') {
		window.UserMedia = UserMedia; // 
	} else {
		PM.UserMedia = function(options) {
			return new UserMedia(options); // 
		};
	}

	UserMedia.prototype = {
		init: function(options) {
			// The default options
			this.options = {
				id: '', // The id of messages being broadcast.
				target: null,
				audio: true,
				video: true,
				open: true
			};
			// Read in instancing options.
			for(var option in options) {
				if(options.hasOwnProperty(option)) {
					this.options[option] = options[option];
				}
			}
			this.target = typeof this.options.target === 'string' ? document.querySelector(this.options.target) : this.options.target;

			navigator.getUserMedia = navigator.getUserMedia ||
				navigator.webkitGetUserMedia ||
				navigator.mozGetUserMedia ||
				navigator.msGetUserMedia;

			if(this.options.open) {
				this.open();
			}
		},
		broadcast: function(type) {
			// Broadcast the message
			if(PM) {
				PM.broadcast(type, {
					id: this.options.id,
					target: this,
					msg: 'Generated by: UserMedia'
				});
			}
		},
		open: function() {
			var self = this;
			navigator.getUserMedia({
				audio: self.options.audio,
				video: self.options.video
			}, function(stream) {
				self.stream = stream;
				self.success(stream);
				self.broadcast("usermedia");
			}, function(error) {
				self.error = error;
				self.broadcast("usermedia_error");
			});
		},
		success: function(stream) {
			if(this.target && this.options.video) {
				this.videoElem = document.createElement('video');
				this.videoElem.src = window.URL.createObjectURL(stream);
				this.target.appendChild(this.videoElem);
				this.videoElem.play();
			}
		}
	};
}(window.PM));
